name: CMF Orchestration Build & Deploy

on:
  workflow_dispatch:
    inputs:
      cmf_version:
        description: "CMF tag or version (e.g. v4.5.1, v4.6.0, custom001)"
        required: true
        default: "v4.5.1"
      solution_name:
        description: "Solution name folder (must match AWS CMF repo structure)"
        required: true
        default: "cloud-migration-factory-on-aws"
      stack_name:
        description: "CloudFormation stack name for CMF factory"
        required: true
        default: "cmf-orchestration"
      region:
        description: "AWS region for CMF deployment"
        required: true
        default: "us-east-1"
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - stage
          - prod
      use_changeset_review:
        description: "Create CloudFormation change set for manual review (auto-enabled for prod)"
        required: false
        default: false
        type: boolean
      tag_overrides:
        description: "Additional resource tags (newline-separated key=value entries)"
        required: false
      kms_key_arn:
        description: "KMS key ARN for S3 encryption (optional, defaults to AES256)"
        required: false
      enable_prod_stack_policy:
        description: "Apply protective stack policy in production (recommended)"
        required: false
        default: true
        type: boolean
      target_account_stack_name:
        description: "CloudFormation stack name to use in target accounts"
        required: false
        default: "cmf-target-account"
      target_replatform:
        description: "Enable Replatform (EC2) role deployment in target accounts"
        required: false
        default: true
        type: boolean
      target_rehost_mgn:
        description: "Enable MGN automation role deployment in target accounts"
        required: false
        default: true
        type: boolean

permissions:
  id-token: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ inputs.stack_name }}-${{ inputs.region }}
  cancel-in-progress: false

jobs:
  validate:
    uses: ./.github/workflows/cmf-validate.yml
    with:
      cmf_version: ${{ inputs.cmf_version }}
      solution_name: ${{ inputs.solution_name }}
      stack_name: ${{ inputs.stack_name }}
      region: ${{ inputs.region }}
      environment: ${{ inputs.environment }}
      kms_key_arn: ${{ inputs.kms_key_arn }}
      tag_overrides: ${{ inputs.tag_overrides }}
      client_name: ${{ vars.CLIENT_NAME }}

  build:
    needs: validate
    uses: ./.github/workflows/cmf-build.yml
    with:
      cmf_version: ${{ inputs.cmf_version }}
      solution_name: ${{ inputs.solution_name }}
      stack_name: ${{ inputs.stack_name }}
      region: ${{ inputs.region }}
      environment: ${{ inputs.environment }}
      kms_key_arn: ${{ inputs.kms_key_arn }}
      tag_overrides: ${{ inputs.tag_overrides }}
      client_name: ${{ vars.CLIENT_NAME }}
      param_file: ${{ needs.validate.outputs.param_file }}
      cfn_lint_version: "1.14.3"
      node_version: "20"
      role_dev: "${{ vars.ACCOUNT_DEV != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_DEV) : '' }}"
      role_stage: "${{ vars.ACCOUNT_STAGE != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_STAGE) : '' }}"
      role_prod: "${{ vars.ACCOUNT_PROD != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_PROD) : '' }}"

  deploy:
    needs: build
    environment: ${{ inputs.environment }}
    uses: ./.github/workflows/cmf-deploy.yml
    with:
      cmf_version: ${{ inputs.cmf_version }}
      solution_name: ${{ inputs.solution_name }}
      stack_name: ${{ inputs.stack_name }}
      region: ${{ inputs.region }}
      environment: ${{ inputs.environment }}
      param_file: ${{ needs.validate.outputs.param_file }}
      template_bucket: ${{ needs.build.outputs.template_bucket }}
      asset_bucket: ${{ needs.build.outputs.asset_bucket }}
      account_id: ${{ needs.build.outputs.account_id }}
      stack_tags_json: ${{ needs.build.outputs.stack_tags_json }}
      use_changeset: "${{ inputs.environment == 'prod' || inputs.use_changeset_review == true ? 'true' : 'false' }}"
      enable_prod_stack_policy: "${{ inputs.environment == 'prod' && inputs.enable_prod_stack_policy == true ? 'true' : 'false' }}"
      cfn_service_role_name: "CFN-ServiceRole-CMF"
      role_dev: "${{ vars.ACCOUNT_DEV != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_DEV) : '' }}"
      role_stage: "${{ vars.ACCOUNT_STAGE != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_STAGE) : '' }}"
      role_prod: "${{ vars.ACCOUNT_PROD != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_PROD) : '' }}"

  target-bootstrap:
    needs: deploy
    if: ${{ needs.deploy.result == 'success' && secrets.TARGET_ACCOUNT_CONFIGS != '' }}
    timeout-minutes: 60
    uses: ./.github/workflows/cmf-target-account-init.yml
    with:
      solution_name: ${{ inputs.solution_name }}
      cmf_version: ${{ inputs.cmf_version }}
      region: ${{ inputs.region }}
      environment: ${{ inputs.environment }}
      template_bucket: ${{ needs.build.outputs.template_bucket }}
      account_id: ${{ needs.build.outputs.account_id }}
      target_stack_name: ${{ inputs.target_account_stack_name }}
      target_replatform: "${{ inputs.target_replatform == true ? 'true' : 'false' }}"
      target_rehost_mgn: "${{ inputs.target_rehost_mgn == true ? 'true' : 'false' }}"
      role_dev: "${{ vars.ACCOUNT_DEV != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_DEV) : '' }}"
      role_stage: "${{ vars.ACCOUNT_STAGE != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_STAGE) : '' }}"
      role_prod: "${{ vars.ACCOUNT_PROD != '' ? format('arn:aws:iam::{0}:role/GitHub-CMF-PipelineRole', vars.ACCOUNT_PROD) : '' }}"
    secrets:
      target_account_configs: ${{ secrets.TARGET_ACCOUNT_CONFIGS }}

  summary:
    needs: [build, deploy]
    if: ${{ always() }}
    uses: ./.github/workflows/cmf-summary.yml
    with:
      stack_name: ${{ inputs.stack_name }}
      cmf_version: ${{ inputs.cmf_version }}
      solution_name: ${{ inputs.solution_name }}
      environment: ${{ inputs.environment }}
      region: ${{ inputs.region }}
      account_id: ${{ needs.build.outputs.account_id }}
      template_bucket: ${{ needs.build.outputs.template_bucket }}
      asset_bucket: ${{ needs.build.outputs.asset_bucket }}
      stack_tags_display: ${{ needs.build.outputs.stack_tags_display }}
      has_target_accounts: ${{ secrets.TARGET_ACCOUNT_CONFIGS != '' ? 'true' : 'false' }}
      stack_id: ${{ needs.deploy.outputs.stack_id }}
